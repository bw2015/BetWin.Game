<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>BetWin.Game API测试</title>
    <base href="//localhost:5000/BetWin.Game.Test/" />
    <link rel="stylesheet" href="//studio.a8.to/lay/ui/css/layui.css" />
    <link rel="stylesheet" href="//studio.a8.to/lay/ui/css/layui.extend.css" />
    <script type="text/javascript" src="//studio.a8.to/lay/ui/layui.js"></script>
    <script type="text/javascript" src="//studio.a8.to/lay/admin/layui.extend.js"></script>
    <style type="text/css">
        fieldset { max-width: 800px; margin: auto; }
        .layui-form.loading { position: relative; }
            .layui-form.loading::after { content: " "; position: absolute; left: 0px; top: 0px; right: 0px; bottom: 0px; background-color: rgba(0,0,0,.5); }
        .layui-form-item.result { border-top: 1px solid #ccc; word-break: break-all; padding: 0px 20px; line-height: 200%; max-height: 400px; overflow: auto; }
    </style>
</head>
<body>
    <fieldset>
        <legend>接口配置</legend>
        <form class="layui-form" lay-filter="form">
            <div class="layui-form-item">
                <label class="layui-form-label">网关</label>
                <div class="layui-input-inline">
                    <input type="text" id="gateway" class="layui-input" />
                </div>
                <label class="layui-form-label">游戏接口</label>
                <div class="layui-input-inline">
                    <select id="gametype" lay-filter="gametype"></select>
                </div>
            </div>
            <hr />
            <div class="layui-form-item" id="setting"></div>
        </form>
    </fieldset>

    <fieldset>
        <legend>注册</legend>
        <form action="Register" class="layui-form" lay-filter="form">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">前缀</label>
                    <div class="layui-input-inline">
                        <input type="text" name="prefix" class="layui-input" />
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">用户名</label>
                    <div class="layui-input-inline">
                        <input type="text" name="username" class="layui-input" />
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">币种</label>
                    <div class="layui-input-inline">
                        <select name="Currency"></select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">语种</label>
                    <div class="layui-input-inline">
                        <select name="Language"></select>
                    </div>
                </div>
            </div>
        </form>
    </fieldset>

    <fieldset>
        <legend>登录</legend>
        <form action="Login" class="layui-form" lay-filter="form">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">用户名</label>
                    <div class="layui-input-inline">
                        <input type="text" name="username" class="layui-input" />
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">币种</label>
                    <div class="layui-input-inline">
                        <select name="Currency"></select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">语种</label>
                    <div class="layui-input-inline">
                        <select name="Language"></select>
                    </div>
                </div>
            </div>
        </form>
    </fieldset>

    <fieldset>
        <legend>查询余额</legend>
        <form action="Balance" class="layui-form" lay-filter="form">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">用户名</label>
                    <div class="layui-input-inline">
                        <input type="text" name="username" class="layui-input" />
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">币种</label>
                    <div class="layui-input-inline">
                        <select name="Currency"></select>
                    </div>
                </div>
            </div>
        </form>
    </fieldset>


    <fieldset>
        <legend>上分/下分</legend>
        <form action="Transfer" class="layui-form" lay-filter="form">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">用户名</label>
                    <div class="layui-input-inline">
                        <input type="text" name="username" class="layui-input" />
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">分数</label>
                    <div class="layui-input-inline">
                        <input type="number" name="money" class="layui-input" placeholder="正数为上分，负数为下分" />
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">订单号</label>
                    <div class="layui-input-inline">
                        <input type="text" name="orderId" class="layui-input" ondblclick="this.value = Date.now()" />
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">币种</label>
                    <div class="layui-input-inline">
                        <select name="Currency"></select>
                    </div>
                </div>
            </div>
        </form>
    </fieldset>

    <fieldset>
        <legend>检查转账订单</legend>
        <form action="CheckTransfer" class="layui-form" lay-filter="form">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">用户名</label>
                    <div class="layui-input-inline">
                        <input type="text" name="username" class="layui-input" />
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">订单号</label>
                    <div class="layui-input-inline">
                        <input type="text" name="orderId" class="layui-input" ondblclick="this.value = Date.now()" />
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">币种</label>
                    <div class="layui-input-inline">
                        <select name="Currency"></select>
                    </div>
                </div>
            </div>
        </form>
    </fieldset>


    <fieldset>
        <legend>订单拉取</legend>
        <form action="GetOrder" class="layui-form" lay-filter="form">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">开始时间</label>
                    <div class="layui-input-inline">
                        <input type="datetime-local" name="startTime" class="layui-input" />
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">结束时间</label>
                    <div class="layui-input-inline">
                        <input type="datetime-local" name="endTime" class="layui-input" />
                    </div>
                </div>
            </div>
        </form>
    </fieldset>


    <script type="text/javascript">
        layui.use(["jquery", "form"], () => {
            const $ = layui.$,
                form = layui.form,
                currencies = new Map([["CNY", "人民币"], ["VND", "越南盾"], ["KVND", "千越南盾"]]),
                languages = new Map([["CHN", "简体中文"], ["ENG", "英文"]]);

            currencies.forEach((name, key) => {
                document.querySelectorAll("[name='Currency']").forEach(t => {
                    t.options.add(new Option(name, key));
                });
            });
            languages.forEach((name, key) => {
                document.querySelectorAll("[name='Language']").forEach(t => {
                    t.options.add(new Option(name, key));
                });
            });

            document.querySelectorAll("form[action]").forEach(t => {
                let submit = document.createElement("div");
                submit.className = "layui-form-item layui-text-center";
                submit.innerHTML = [`<button class="layui-btn" lay-submit lay-filter="form-submit">提交</button>`].join("");
                t.appendChild(submit);
            });

            !function (gateway) {
                let value = localStorage.getItem("GATEWAY");
                if (value) gateway.value = value;
                $(gateway).change(e => {
                    console.log(e);
                    localStorage.setItem("GATEWAY", gateway.value);
                });
            }(document.getElementById("gateway"));

            let loadSetting = () => {
                let type = document.getElementById("gametype").value;
                $.post("GetGameSetting", {
                    type
                }).then(res => {
                    let data = {},
                        html = [],
                        type = document.getElementById("gametype").value;
                    if (localStorage.getItem(type)) {
                        data = JSON.parse(localStorage.getItem(type));
                    }
                    console.log(data);
                    for (let name in res.info) {
                        let label = res.info[name];
                        html.push(`<div class="layui-inline">`,
                            `<label class="layui-form-label">${label}</label>`,
                            `<div class="layui-input-inline"><input type="text" data-setting="${name}" class="layui-input" value="${data[name] || ""}" /></div>`,
                            `</div>`);
                    }
                    document.getElementById("setting").innerHTML = html.join("");
                });
            }, getSetting = () => {
                let data = {},
                    type = document.getElementById("gametype").value;
                document.getElementById("setting").querySelectorAll("[data-setting]").forEach(t => {
                    let name = t.getAttribute("data-setting"),
                        value = t.value;
                    data[name] = value;
                });
                localStorage.setItem(type, JSON.stringify(data));
                return data;
            },
                getAction = elem => {
                    let action = elem.getAttribute("action");
                    return document.getElementById("gateway").value + action + "?type=" + document.getElementById("gametype").value;
                },
                // 现实结果
                showResult = (elem, res) => {
                    //#1 清除原有的结果元素
                    document.querySelectorAll(".result").forEach(t => t.remove());
                    let result = document.createElement("div");
                    result.className = "layui-form-item result";
                    result.id = `result-${Date.now()}`;
                    elem.appendChild(result);
                    Utils.jsonViewer(result.id, res);
                }

            form.on("select(gametype)", loadSetting);

            $.post("GetGameType").then(res => {
                for (let type in res.info) {
                    document.getElementById("gametype").options.add(new Option(res.info[type], type));
                }
                form.render(null, "form");
                loadSetting();
            });

            form.on("submit(form-submit)", e => {
                let url = getAction(e.form),
                    setting = JSON.stringify(getSetting()),
                    data = e.field;

                data["setting"] = setting;
                e.form.classList.add("loading");
                $.post(url, data).then(
                    res => {
                        e.form.classList.remove("loading");
                        showResult(e.form, res);
                    }, ex => {
                        e.form.classList.remove("loading");
                        layer.alert(ex.responseText, {
                            icon: 2
                        });
                    });
                return false;
            });


        });
    </script>
</body>
</html>